description: >
  This command will start Tailscale in userspace networking mode
parameters:
  tailscale-auth-key:
    type: env_var_name
    description: Tailscale authentication key from the admin panel (Ephemeral key)
    default: TAILSCALE_AUTH_KEY
  http-proxy-port:
    type: string
    default: "1054"
    description: "HTTP proxy port"
  socks5-proxy-port:
    type: string
    default: "1055"
    description: "SOCKS5 proxy port"
steps:
  - run:
      environment:
        HTTP_PROXY_PORT: <<parameters.http-proxy-port>>
        SOCKS5_PROXY_PORT: <<parameters.socks5-proxy-port>>
      name: Run Tailscaled process
      command: <<include(scripts/start-tailscaled.sh)>>
  - run: |
      {
        echo "export TAILSCALE_AUTH_KEY=$TAILSCALE_AUTH_KEY"
      } >> $BASH_ENV
  - run:
      environment:
        TAILSCALE_AUTH_KEY: <<parameters.tailscale-auth-key>>
      name: Auth Tailscale
      command: <<include(scripts/auth-tailscale-agent.sh)>>
  - run:
      name: Export Proxy Env Vars
      command: <<include(scripts/export-proxy-env-vars.sh)>>
  # - run: |
  #     {
  #       echo "export TAILSCALE_AUTH_KEY=$TAILSCALE_AUTH_KEY"
  #     } >> $BASH_ENV
  # - run:
  #     environment:
  #       TAILSCALE_AUTH_KEY: <<parameters.tailscale-auth-key>>
  #       HTTP_PROXY_PORT: <<parameters.http-proxy-port>>
  #       SOCKS5_PROXY_PORT: <<parameters.socks5-proxy-port>>
  #     name: Run Tailscale Agent
  #     command: <<include(scripts/connect.sh)>>
